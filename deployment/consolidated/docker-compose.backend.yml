# ==============================================================================
# Plane Backend Services - Docker Compose (CONSOLIDATED)
# ==============================================================================
# This compose file contains ALL backend services in a single application:
# - API Backend (Django + Gunicorn)
# - Worker (Celery background tasks)
# - Beat Worker (Celery scheduler)
# - Live Server (WebSocket collaboration)
#
# Deploy this as ONE Dokploy application for simpler management
# ==============================================================================

version: '3.8'

services:
  # ============================================================================
  # API Backend (Django + Gunicorn)
  # ============================================================================
  api:
    container_name: plane-api
    build:
      context: ../../
      dockerfile: ./apps/api/Dockerfile.api
      args:
        DOCKER_BUILDKIT: 1
    restart: always
    command: ./bin/docker-entrypoint-api.sh
    environment:
      # Django Configuration
      SECRET_KEY: ${SECRET_KEY}
      DEBUG: ${DEBUG:-0}
      DJANGO_SETTINGS_MODULE: plane.settings.production

      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@plane-postgres:5432/${POSTGRES_DB}
      PGHOST: plane-postgres
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER}
      PGPASSWORD: ${POSTGRES_PASSWORD}
      PGDATABASE: ${POSTGRES_DB}

      # Redis
      REDIS_URL: redis://plane-redis:6379/
      REDIS_HOST: plane-redis
      REDIS_PORT: 6379

      # RabbitMQ
      RABBITMQ_HOST: plane-rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_VHOST: ${RABBITMQ_VHOST:-plane}
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
      CELERY_BROKER_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@plane-rabbitmq:5672/${RABBITMQ_VHOST:-plane}

      # URLs
      WEB_URL: ${WEB_URL}
      API_BASE_URL: ${API_BASE_URL}
      ADMIN_BASE_URL: ${ADMIN_BASE_URL}
      ADMIN_BASE_PATH: ${ADMIN_BASE_PATH:-/god-mode}
      SPACE_BASE_URL: ${SPACE_BASE_URL}
      SPACE_BASE_PATH: ${SPACE_BASE_PATH:-/spaces}
      LIVE_BASE_URL: ${LIVE_BASE_URL}
      LIVE_BASE_PATH: ${LIVE_BASE_PATH:-/live}

      # CORS
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}

      # Storage
      USE_MINIO: ${USE_MINIO:-1}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_S3_ENDPOINT_URL: ${AWS_S3_ENDPOINT_URL:-http://plane-minio:9000}
      AWS_S3_BUCKET_NAME: ${AWS_S3_BUCKET_NAME:-uploads}
      FILE_SIZE_LIMIT: ${FILE_SIZE_LIMIT:-5242880}
      MINIO_ENDPOINT_SSL: ${MINIO_ENDPOINT_SSL:-0}

      # Gunicorn
      GUNICORN_WORKERS: ${GUNICORN_WORKERS:-2}

      # Email (optional)
      EMAIL_BACKEND: ${EMAIL_BACKEND:-django.core.mail.backends.smtp.EmailBackend}
      EMAIL_HOST: ${EMAIL_HOST:-smtp.gmail.com}
      EMAIL_PORT: ${EMAIL_PORT:-587}
      EMAIL_USE_TLS: ${EMAIL_USE_TLS:-1}
      EMAIL_HOST_USER: ${EMAIL_HOST_USER:-}
      EMAIL_HOST_PASSWORD: ${EMAIL_HOST_PASSWORD:-}
      DEFAULT_FROM_EMAIL: ${DEFAULT_FROM_EMAIL:-noreply@mohdop.com}

      # AI Integration (optional)
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      GPT_ENGINE: ${GPT_ENGINE:-gpt-4}

      # Security
      ALLOWED_HOSTS: ${ALLOWED_HOSTS}
      SESSION_COOKIE_SECURE: 1
      CSRF_COOKIE_SECURE: 1

      # Python
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1

    networks:
      - plane-network

    labels:
      # Traefik labels for API
      - "traefik.enable=true"
      - "traefik.http.routers.plane-api.rule=Host(`${API_DOMAIN}`)"
      - "traefik.http.routers.plane-api.entrypoints=websecure"
      - "traefik.http.routers.plane-api.tls=true"
      - "traefik.http.routers.plane-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.plane-api.loadbalancer.server.port=8000"

  # ============================================================================
  # Celery Worker (Background Tasks)
  # ============================================================================
  worker:
    container_name: plane-worker
    build:
      context: ../../
      dockerfile: ./apps/api/Dockerfile.api
      args:
        DOCKER_BUILDKIT: 1
    restart: always
    command: ./bin/docker-entrypoint-worker.sh
    environment:
      # Same environment as API
      SECRET_KEY: ${SECRET_KEY}
      DEBUG: ${DEBUG:-0}
      DJANGO_SETTINGS_MODULE: plane.settings.production

      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@plane-postgres:5432/${POSTGRES_DB}
      PGHOST: plane-postgres
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER}
      PGPASSWORD: ${POSTGRES_PASSWORD}
      PGDATABASE: ${POSTGRES_DB}

      # Redis
      REDIS_URL: redis://plane-redis:6379/
      REDIS_HOST: plane-redis
      REDIS_PORT: 6379

      # RabbitMQ
      RABBITMQ_HOST: plane-rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_VHOST: ${RABBITMQ_VHOST:-plane}
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
      CELERY_BROKER_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@plane-rabbitmq:5672/${RABBITMQ_VHOST:-plane}

      # URLs
      WEB_URL: ${WEB_URL}
      API_BASE_URL: ${API_BASE_URL}

      # Storage
      USE_MINIO: ${USE_MINIO:-1}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_S3_ENDPOINT_URL: ${AWS_S3_ENDPOINT_URL:-http://plane-minio:9000}
      AWS_S3_BUCKET_NAME: ${AWS_S3_BUCKET_NAME:-uploads}

      # Email (for worker to send emails)
      EMAIL_BACKEND: ${EMAIL_BACKEND:-django.core.mail.backends.smtp.EmailBackend}
      EMAIL_HOST: ${EMAIL_HOST:-smtp.gmail.com}
      EMAIL_PORT: ${EMAIL_PORT:-587}
      EMAIL_USE_TLS: ${EMAIL_USE_TLS:-1}
      EMAIL_HOST_USER: ${EMAIL_HOST_USER:-}
      EMAIL_HOST_PASSWORD: ${EMAIL_HOST_PASSWORD:-}
      DEFAULT_FROM_EMAIL: ${DEFAULT_FROM_EMAIL:-noreply@mohdop.com}

      # AI (optional)
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      GPT_ENGINE: ${GPT_ENGINE:-gpt-4}

      # Python
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1

    networks:
      - plane-network

  # ============================================================================
  # Celery Beat Scheduler (Scheduled Tasks)
  # ============================================================================
  beat-worker:
    container_name: plane-beat-worker
    build:
      context: ../../
      dockerfile: ./apps/api/Dockerfile.api
      args:
        DOCKER_BUILDKIT: 1
    restart: always
    command: ./bin/docker-entrypoint-beat.sh
    environment:
      SECRET_KEY: ${SECRET_KEY}
      DEBUG: ${DEBUG:-0}
      DJANGO_SETTINGS_MODULE: plane.settings.production

      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@plane-postgres:5432/${POSTGRES_DB}
      PGHOST: plane-postgres
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER}
      PGPASSWORD: ${POSTGRES_PASSWORD}
      PGDATABASE: ${POSTGRES_DB}

      # Redis
      REDIS_URL: redis://plane-redis:6379/
      REDIS_HOST: plane-redis
      REDIS_PORT: 6379

      # RabbitMQ
      RABBITMQ_HOST: plane-rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_VHOST: ${RABBITMQ_VHOST:-plane}
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
      CELERY_BROKER_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@plane-rabbitmq:5672/${RABBITMQ_VHOST:-plane}

      # Python
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1

    networks:
      - plane-network

  # ============================================================================
  # Live Server (Real-time Collaboration)
  # ============================================================================
  live:
    container_name: plane-live
    build:
      context: ../../
      dockerfile: ./apps/live/Dockerfile.live
      args:
        DOCKER_BUILDKIT: 1
    restart: always
    environment:
      # Server
      PORT: 3100
      NODE_ENV: production

      # API Integration (internal Docker network)
      API_BASE_URL: http://plane-api:8000
      WEB_BASE_URL: ${WEB_URL}
      LIVE_BASE_URL: ${LIVE_BASE_URL}
      LIVE_BASE_PATH: ${LIVE_BASE_PATH:-/live}

      # Authentication (MUST match API SECRET_KEY!)
      LIVE_SERVER_SECRET_KEY: ${SECRET_KEY}

      # Redis
      REDIS_URL: redis://plane-redis:6379/
      REDIS_HOST: plane-redis
      REDIS_PORT: 6379

      # CORS
      ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}

    networks:
      - plane-network

    labels:
      # Traefik labels for Live Server (path-based routing)
      - "traefik.enable=true"
      - "traefik.http.routers.plane-live.rule=Host(`${FRONTEND_DOMAIN}`) && PathPrefix(`/live`)"
      - "traefik.http.routers.plane-live.entrypoints=websecure"
      - "traefik.http.routers.plane-live.tls=true"
      - "traefik.http.routers.plane-live.tls.certresolver=letsencrypt"
      - "traefik.http.services.plane-live.loadbalancer.server.port=3100"

# ==============================================================================
# Network Configuration
# ==============================================================================
# Connect to external plane-network created by docker-compose.infra.yml
networks:
  plane-network:
    external: true
    name: plane-network
